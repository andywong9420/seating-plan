<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å®¤åº§ä½è¡¨ç”¢ç”Ÿå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 0;
            min-height: 600px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 25px;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px 5px 5px 0;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        label {
            display: block;
            margin-top: 12px;
            font-weight: 600;
            color: #495057;
        }

        .workspace {
            padding: 30px;
            overflow: auto;
        }

        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .classroom {
            display: inline-block;
            padding: 30px;
            background: white;
            border: 3px solid #dee2e6;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .podium {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .podium-bottom {
            margin-bottom: 0;
            margin-top: 20px;
        }

        .seat-grid {
            display: grid;
            gap: 12px;
        }

        .seat-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .seat {
            width: 80px;
            height: 90px;
            border: 3px solid #667eea;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: move;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
            transition: all 0.3s;
            position: relative;
        }

        .seat:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .seat.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .seat.empty {
            border: 2px dashed #ccc;
            background: transparent;
            cursor: default;
        }

        .seat.empty:hover {
            transform: none;
            box-shadow: none;
        }

        .seat.conflict {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff0f0 0%, #ffe0e0 100%);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .seat.fixed {
            border-color: #28a745;
            background: linear-gradient(135deg, #f0fff0 0%, #e0ffe0 100%);
        }

        .seat.fixed::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.8em;
        }

        .seat-number {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: 600;
        }

        .seat-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #212529;
            margin-top: 5px;
        }

        .rule-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rule-item button {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .student-select {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .export-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .snapshot-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
        }

        .snapshot-item:hover {
            background: #e9ecef;
        }

        .snapshot-name {
            font-weight: bold;
            color: #212529;
            margin-bottom: 5px;
        }

        .snapshot-date {
            font-size: 0.85em;
            color: #6c757d;
        }

        .snapshot-actions {
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        .info-box {
            padding: 15px;
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            border-radius: 8px;
            margin: 15px 0;
            color: #0c5460;
        }

        .error-box {
            padding: 15px;
            background: #f8d7da;
            border-left: 4px solid #721c24;
            border-radius: 8px;
            margin: 15px 0;
            color: #721c24;
        }

        .success-box {
            padding: 15px;
            background: #d4edda;
            border-left: 4px solid #155724;
            border-radius: 8px;
            margin: 15px 0;
            color: #155724;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        @media print {
            body {
                background: white;
            }
            .sidebar, .header, .view-controls {
                display: none !important;
            }
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ•™å®¤åº§ä½è¡¨ç”¢ç”Ÿå™¨</h1>
            <p>æ™ºèƒ½ç®¡ç†ç­ç´šåº§ä½ï¼Œè¼•é¬†é‡æ’èˆ‡åŒ¯å‡º</p>
        </div>

        <div class="main-content">
            <!-- å´é‚Šæ¬„ -->
            <div class="sidebar">
                <!-- åå–®ç®¡ç† -->
                <div class="section">
                    <h3>ğŸ“‹ åå–®ç®¡ç†</h3>
                    <button class="btn btn-secondary" onclick="app.downloadTemplate()">ä¸‹è¼‰ç¯„æœ¬</button>
                    <label for="csvFile" class="file-upload-label">ğŸ“‚ åŒ¯å…¥ CSV</label>
                    <input type="file" id="csvFile" accept=".csv" onchange="app.importCSV(event)">
                    <div id="studentCount" class="info-box hidden"></div>
                </div>

                <!-- æ•™å®¤è¨­å®š -->
                <div class="section">
                    <h3>ğŸ« æ•™å®¤è¨­å®š</h3>
                    <label>æ’æ•¸ï¼ˆå‰å¾Œï¼‰</label>
                    <input type="number" id="rows" value="6" min="1" max="10" onchange="app.updateConfig()">

                    <label>åˆ—æ•¸ï¼ˆå·¦å³ï¼‰</label>
                    <input type="number" id="cols" value="6" min="1" max="8" onchange="app.updateConfig()">

                    <label>ç©ºä½è™•ç†</label>
                    <select id="emptySeats" onchange="app.updateConfig()">
                        <option value="show">é¡¯ç¤ºè™›ç·šæ¡†</option>
                        <option value="hide">å®Œå…¨éš±è—</option>
                    </select>
                </div>

                <!-- è¦å‰‡è¨­å®š -->
                <div class="section">
                    <h3>âš™ï¸ è¦å‰‡è¨­å®š</h3>

                    <button class="btn btn-primary" onclick="app.showAddRule('adjacent')">æ–°å¢ç›¸é„°é™åˆ¶</button>
                    <button class="btn btn-primary" onclick="app.showAddRule('ninegrid')">æ–°å¢ä¹å®®æ ¼é™åˆ¶</button>
                    <button class="btn btn-success" onclick="app.showAddRule('fixed')">å›ºå®šåº§ä½</button>

                    <div id="rulesList"></div>

                    <label>å‰å¾Œç¿»è½‰å¼·åº¦</label>
                    <select id="flipVertical">
                        <option value="0">ç„¡</option>
                        <option value="30">ä½ (30%)</option>
                        <option value="60">ä¸­ (60%)</option>
                        <option value="90">é«˜ (90%)</option>
                    </select>

                    <label>å·¦å³ç¿»è½‰å¼·åº¦</label>
                    <select id="flipHorizontal">
                        <option value="0">ç„¡</option>
                        <option value="30">ä½ (30%)</option>
                        <option value="60">ä¸­ (60%)</option>
                        <option value="90">é«˜ (90%)</option>
                    </select>
                </div>

                <!-- ç”¢ç”Ÿåº§ä½ -->
                <div class="section">
                    <h3>ğŸ² åº§ä½ç”¢ç”Ÿ</h3>
                    <button class="btn btn-success" onclick="app.generateSeating()" style="width: 100%;">é‡æ–°ç”¢ç”Ÿåº§ä½</button>
                    <button class="btn btn-danger" onclick="app.autoFixConflicts()" style="width: 100%; margin-top: 10px;">è‡ªå‹•ä¿®æ­£è¡çª</button>
                </div>

                <!-- åŒ¯å‡º -->
                <div class="section">
                    <h3>ğŸ’¾ åŒ¯å‡º</h3>
                    <div class="export-section">
                        <button class="btn btn-primary" onclick="app.exportPNG()">PNG åœ–ç‰‡</button>
                        <button class="btn btn-primary" onclick="app.exportPDF()">PDF æ–‡ä»¶</button>
                        <button class="btn btn-secondary" onclick="app.exportCSV()">CSV è³‡æ–™</button>
                        <button class="btn btn-secondary" onclick="app.exportJSON()">JSON å‚™ä»½</button>
                    </div>
                </div>

                <!-- æ­·å²è¨˜éŒ„ -->
                <div class="section">
                    <h3>ğŸ“š æ­·å²è¨˜éŒ„</h3>
                    <input type="text" id="snapshotName" placeholder="è¼¸å…¥å¿«ç…§åç¨±">
                    <button class="btn btn-success" onclick="app.saveSnapshot()" style="width: 100%;">ä¿å­˜å¿«ç…§</button>
                    <div id="snapshotsList"></div>
                </div>
            </div>

            <!-- å·¥ä½œå€ -->
            <div class="workspace">
                <div class="view-controls">
                    <div>
                        <label style="display: inline; margin-right: 10px;">è¦–è§’åˆ‡æ›ï¼š</label>
                        <button class="btn btn-primary" onclick="app.setView('teacher')">æ•™å¸«è¦–è§’</button>
                        <button class="btn btn-primary" onclick="app.setView('student')">å­¸ç”Ÿè¦–è§’</button>
                    </div>
                    <div>
                        <span id="currentView" style="font-weight: bold; color: #667eea;">ç•¶å‰ï¼šæ•™å¸«è¦–è§’</span>
                    </div>
                </div>

                <div id="classroomContainer"></div>
            </div>
        </div>
    </div>

    <!-- è¦å‰‡å°è©±æ¡† -->
    <div id="ruleDialog" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 16px; width: 500px; max-width: 90%;">
            <h3 id="dialogTitle" style="margin-bottom: 20px;"></h3>
            <div id="dialogContent"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="app.closeDialog()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="app.confirmRule()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const app = {
            students: [],
            seating: [],
            rules: {
                adjacent: [],
                ninegrid: [],
                fixed: []
            },
            config: {
                rows: 6,
                cols: 6,
                emptySeats: 'show',
                view: 'teacher'
            },
            draggedElement: null,
            draggedData: null,
            currentRuleType: null,

            init() {
                this.renderClassroom();
                this.renderRules();
                this.renderSnapshots();
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        this.undo();
                    }
                });
            },

            downloadTemplate() {
                const csv = 'åº§è™Ÿ,å§“å\n1,ç‹å°æ˜\n2,æå°è¯\n3,é™³å°ç¾';
                const blob = new Blob(['ï»¿' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'å­¸ç”Ÿåå–®ç¯„æœ¬.csv';
                link.click();
            },

            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        const students = [];

                        for (let i = 1; i < lines.length; i++) {
                            const parts = lines[i].split(',');
                            if (parts.length >= 2) {
                                const seatNo = parseInt(parts[0].trim());
                                const name = parts[1].trim();

                                if (isNaN(seatNo) || seatNo <= 0) {
                                    throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šåº§è™Ÿå¿…é ˆç‚ºæ­£æ•´æ•¸`);
                                }
                                if (!name) {
                                    throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šå§“åä¸èƒ½ç‚ºç©º`);
                                }

                                students.push({ seatNo, name });
                            }
                        }

                        // Check for duplicate seat numbers
                        const seatNos = students.map(s => s.seatNo);
                        const duplicates = seatNos.filter((item, index) => seatNos.indexOf(item) !== index);
                        if (duplicates.length > 0) {
                            throw new Error(`åº§è™Ÿé‡è¤‡ï¼š${duplicates.join(', ')}`);
                        }

                        this.students = students;
                        document.getElementById('studentCount').className = 'success-box';
                        document.getElementById('studentCount').textContent = `æˆåŠŸåŒ¯å…¥ ${students.length} ä½å­¸ç”Ÿ`;
                        this.generateSeating();
                    } catch (error) {
                        document.getElementById('studentCount').className = 'error-box';
                        document.getElementById('studentCount').textContent = `åŒ¯å…¥å¤±æ•—ï¼š${error.message}`;
                    }
                    document.getElementById('studentCount').classList.remove('hidden');
                };
                reader.readAsText(file, 'UTF-8');
            },

            updateConfig() {
                this.config.rows = parseInt(document.getElementById('rows').value);
                this.config.cols = parseInt(document.getElementById('cols').value);
                this.config.emptySeats = document.getElementById('emptySeats').value;
                this.renderClassroom();
            },

            generateSeating() {
                if (this.students.length === 0) {
                    alert('è«‹å…ˆåŒ¯å…¥å­¸ç”Ÿåå–®');
                    return;
                }

                const totalSeats = this.config.rows * this.config.cols;
                if (this.students.length > totalSeats) {
                    alert(`åº§ä½ä¸è¶³ï¼å­¸ç”Ÿäººæ•¸ï¼š${this.students.length}ï¼Œåº§ä½æ•¸ï¼š${totalSeats}`);
                    return;
                }

                // Start with students list
                let availableStudents = [...this.students];

                // Initialize seating array
                this.seating = Array(this.config.rows).fill(null).map(() => 
                    Array(this.config.cols).fill(null)
                );

                // Place fixed students first
                this.rules.fixed.forEach(rule => {
                    const student = this.students.find(s => s.seatNo === rule.seatNo);
                    if (student) {
                        this.seating[rule.row][rule.col] = student;
                        availableStudents = availableStudents.filter(s => s.seatNo !== student.seatNo);
                    }
                });

                // Apply flipping logic
                const flipV = parseInt(document.getElementById('flipVertical').value) / 100;
                const flipH = parseInt(document.getElementById('flipHorizontal').value) / 100;

                // Shuffle available students
                availableStudents = this.shuffleWithFlip(availableStudents, flipV, flipH);

                // Fill remaining seats
                let studentIndex = 0;
                for (let r = 0; r < this.config.rows; r++) {
                    for (let c = 0; c < this.config.cols; c++) {
                        if (!this.seating[r][c] && studentIndex < availableStudents.length) {
                            this.seating[r][c] = availableStudents[studentIndex];
                            studentIndex++;
                        }
                    }
                }

                this.renderClassroom();
                this.checkConflicts();
            },

            shuffleWithFlip(array, flipV, flipH) {
                const shuffled = [...array];

                // Apply vertical flip probability
                if (Math.random() < flipV) {
                    shuffled.reverse();
                }

                // Shuffle with horizontal bias
                for (let i = shuffled.length - 1; i > 0; i--) {
                    let j;
                    if (Math.random() < flipH) {
                        // Bias towards opposite end
                        j = Math.floor(Math.random() * i / 2);
                    } else {
                        // Normal random
                        j = Math.floor(Math.random() * (i + 1));
                    }
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }

                return shuffled;
            },

            renderClassroom() {
                const container = document.getElementById('classroomContainer');
                const classroom = document.createElement('div');
                classroom.className = 'classroom';
                classroom.id = 'classroom';

                let html = '';

                // Podium position based on view
                if (this.config.view === 'student') {
                    html += '<div class="podium">ğŸ“š è¬›æ¡Œ ğŸ“š</div>';
                }

                html += '<div class="seat-grid">';

                const rows = this.config.view === 'teacher' ? 
                    [...Array(this.config.rows).keys()].reverse() : 
                    [...Array(this.config.rows).keys()];

                rows.forEach(r => {
                    html += '<div class="seat-row">';
                    for (let c = 0; c < this.config.cols; c++) {
                        const student = this.seating[r]?.[c];
                        const isFixed = this.isFixedSeat(r, c);

                        if (student) {
                            html += `
                                <div class="seat ${isFixed ? 'fixed' : ''}" 
                                     draggable="${!isFixed}"
                                     data-row="${r}" 
                                     data-col="${c}"
                                     ondragstart="app.handleDragStart(event)"
                                     ondragover="app.handleDragOver(event)"
                                     ondrop="app.handleDrop(event)"
                                     ondragend="app.handleDragEnd(event)">
                                    <div class="seat-number">${student.seatNo}</div>
                                    <div class="seat-name">${student.name}</div>
                                </div>
                            `;
                        } else if (this.config.emptySeats === 'show') {
                            html += `
                                <div class="seat empty" 
                                     data-row="${r}" 
                                     data-col="${c}"
                                     ondragover="app.handleDragOver(event)"
                                     ondrop="app.handleDrop(event)">
                                </div>
                            `;
                        }
                    }
                    html += '</div>';
                });

                html += '</div>';

                // Podium at bottom for teacher view
                if (this.config.view === 'teacher') {
                    html += '<div class="podium podium-bottom">ğŸ“š è¬›æ¡Œ ğŸ“š</div>';
                }

                classroom.innerHTML = html;
                container.innerHTML = '';
                container.appendChild(classroom);
            },

            handleDragStart(event) {
                const row = parseInt(event.target.dataset.row);
                const col = parseInt(event.target.dataset.col);
                this.draggedData = { row, col };
                event.target.classList.add('dragging');
                event.dataTransfer.effectAllowed = 'move';
            },

            handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
            },

            handleDrop(event) {
                event.preventDefault();
                const targetRow = parseInt(event.currentTarget.dataset.row);
                const targetCol = parseInt(event.currentTarget.dataset.col);

                if (this.draggedData) {
                    const { row: fromRow, col: fromCol } = this.draggedData;

                    // Swap seats
                    const temp = this.seating[fromRow][fromCol];
                    this.seating[fromRow][fromCol] = this.seating[targetRow][targetCol];
                    this.seating[targetRow][targetCol] = temp;

                    this.renderClassroom();
                    this.checkConflicts();
                }
            },

            handleDragEnd(event) {
                event.target.classList.remove('dragging');
                this.draggedData = null;
            },

            isFixedSeat(row, col) {
                return this.rules.fixed.some(rule => rule.row === row && rule.col === col);
            },

            checkConflicts() {
                // Remove all conflict classes first
                document.querySelectorAll('.seat.conflict').forEach(el => {
                    el.classList.remove('conflict');
                });

                let hasConflict = false;

                // Check adjacent rules
                this.rules.adjacent.forEach(rule => {
                    const pos1 = this.findStudentPosition(rule.student1);
                    const pos2 = this.findStudentPosition(rule.student2);

                    if (pos1 && pos2 && this.areAdjacent(pos1, pos2)) {
                        this.markConflict(pos1);
                        this.markConflict(pos2);
                        hasConflict = true;
                    }
                });

                // Check ninegrid rules
                this.rules.ninegrid.forEach(rule => {
                    const pos1 = this.findStudentPosition(rule.student1);
                    const pos2 = this.findStudentPosition(rule.student2);

                    if (pos1 && pos2 && this.inNineGrid(pos1, pos2)) {
                        this.markConflict(pos1);
                        this.markConflict(pos2);
                        hasConflict = true;
                    }
                });

                if (hasConflict) {
                    setTimeout(() => {
                        alert('åµæ¸¬åˆ°åº§ä½è¡çªï¼è«‹æ‰‹å‹•èª¿æ•´æˆ–é»æ“Šã€Œè‡ªå‹•ä¿®æ­£è¡çªã€');
                    }, 300);
                }
            },

            findStudentPosition(seatNo) {
                for (let r = 0; r < this.seating.length; r++) {
                    for (let c = 0; c < this.seating[r].length; c++) {
                        if (this.seating[r][c]?.seatNo === seatNo) {
                            return { row: r, col: c };
                        }
                    }
                }
                return null;
            },

            areAdjacent(pos1, pos2) {
                const rowDiff = Math.abs(pos1.row - pos2.row);
                const colDiff = Math.abs(pos1.col - pos2.col);
                return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
            },

            inNineGrid(pos1, pos2) {
                const rowDiff = Math.abs(pos1.row - pos2.row);
                const colDiff = Math.abs(pos1.col - pos2.col);
                return rowDiff <= 1 && colDiff <= 1;
            },

            markConflict(pos) {
                const seat = document.querySelector(`[data-row="${pos.row}"][data-col="${pos.col}"]`);
                if (seat) seat.classList.add('conflict');
            },

            autoFixConflicts() {
                let attempts = 0;
                const maxAttempts = 100;

                while (attempts < maxAttempts) {
                    let hasConflict = false;

                    // Check and fix adjacent conflicts
                    for (const rule of this.rules.adjacent) {
                        const pos1 = this.findStudentPosition(rule.student1);
                        const pos2 = this.findStudentPosition(rule.student2);

                        if (pos1 && pos2 && this.areAdjacent(pos1, pos2)) {
                            this.swapWithRandom(pos2);
                            hasConflict = true;
                        }
                    }

                    // Check and fix ninegrid conflicts
                    for (const rule of this.rules.ninegrid) {
                        const pos1 = this.findStudentPosition(rule.student1);
                        const pos2 = this.findStudentPosition(rule.student2);

                        if (pos1 && pos2 && this.inNineGrid(pos1, pos2)) {
                            this.swapWithRandom(pos2);
                            hasConflict = true;
                        }
                    }

                    if (!hasConflict) break;
                    attempts++;
                }

                this.renderClassroom();
                this.checkConflicts();

                if (attempts >= maxAttempts) {
                    alert('ç„¡æ³•è‡ªå‹•ä¿®æ­£æ‰€æœ‰è¡çªï¼Œè«‹æ‰‹å‹•èª¿æ•´');
                } else {
                    alert('è¡çªå·²ä¿®æ­£ï¼');
                }
            },

            swapWithRandom(pos) {
                // Find random non-fixed seat
                const available = [];
                for (let r = 0; r < this.config.rows; r++) {
                    for (let c = 0; c < this.config.cols; c++) {
                        if (!this.isFixedSeat(r, c) && this.seating[r][c]) {
                            available.push({ row: r, col: c });
                        }
                    }
                }

                if (available.length > 0) {
                    const random = available[Math.floor(Math.random() * available.length)];
                    const temp = this.seating[pos.row][pos.col];
                    this.seating[pos.row][pos.col] = this.seating[random.row][random.col];
                    this.seating[random.row][random.col] = temp;
                }
            },

            showAddRule(type) {
                this.currentRuleType = type;
                const dialog = document.getElementById('ruleDialog');
                const title = document.getElementById('dialogTitle');
                const content = document.getElementById('dialogContent');

                if (type === 'fixed') {
                    title.textContent = 'å›ºå®šåº§ä½';
                    content.innerHTML = `
                        <label>é¸æ“‡å­¸ç”Ÿ</label>
                        <select id="fixedStudent">
                            ${this.students.map(s => `<option value="${s.seatNo}">${s.seatNo} - ${s.name}</option>`).join('')}
                        </select>
                        <label>æ’æ•¸ï¼ˆå¾å‰åˆ°å¾Œï¼Œ1-${this.config.rows}ï¼‰</label>
                        <input type="number" id="fixedRow" min="1" max="${this.config.rows}" value="1">
                        <label>åˆ—æ•¸ï¼ˆå¾å·¦åˆ°å³ï¼Œ1-${this.config.cols}ï¼‰</label>
                        <input type="number" id="fixedCol" min="1" max="${this.config.cols}" value="1">
                    `;
                } else {
                    title.textContent = type === 'adjacent' ? 'æ–°å¢ç›¸é„°é™åˆ¶' : 'æ–°å¢ä¹å®®æ ¼é™åˆ¶';
                    content.innerHTML = `
                        <div class="student-select">
                            <select id="student1">
                                ${this.students.map(s => `<option value="${s.seatNo}">${s.seatNo} - ${s.name}</option>`).join('')}
                            </select>
                            <span>å’Œ</span>
                            <select id="student2">
                                ${this.students.map(s => `<option value="${s.seatNo}">${s.seatNo} - ${s.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }

                dialog.classList.remove('hidden');
            },

            closeDialog() {
                document.getElementById('ruleDialog').classList.add('hidden');
            },

            confirmRule() {
                if (this.currentRuleType === 'fixed') {
                    const seatNo = parseInt(document.getElementById('fixedStudent').value);
                    const row = parseInt(document.getElementById('fixedRow').value) - 1;
                    const col = parseInt(document.getElementById('fixedCol').value) - 1;

                    this.rules.fixed.push({ seatNo, row, col });
                } else {
                    const student1 = parseInt(document.getElementById('student1').value);
                    const student2 = parseInt(document.getElementById('student2').value);

                    if (student1 === student2) {
                        alert('ä¸èƒ½é¸æ“‡ç›¸åŒçš„å­¸ç”Ÿ');
                        return;
                    }

                    this.rules[this.currentRuleType].push({ student1, student2 });
                }

                this.renderRules();
                this.closeDialog();
            },

            renderRules() {
                const container = document.getElementById('rulesList');
                let html = '';

                this.rules.adjacent.forEach((rule, index) => {
                    const s1 = this.students.find(s => s.seatNo === rule.student1);
                    const s2 = this.students.find(s => s.seatNo === rule.student2);
                    html += `
                        <div class="rule-item">
                            <span>ğŸš« ç›¸é„°ï¼š${s1?.name} â†” ${s2?.name}</span>
                            <button class="btn btn-danger" onclick="app.removeRule('adjacent', ${index})">åˆªé™¤</button>
                        </div>
                    `;
                });

                this.rules.ninegrid.forEach((rule, index) => {
                    const s1 = this.students.find(s => s.seatNo === rule.student1);
                    const s2 = this.students.find(s => s.seatNo === rule.student2);
                    html += `
                        <div class="rule-item">
                            <span>â¬› ä¹å®®æ ¼ï¼š${s1?.name} â†” ${s2?.name}</span>
                            <button class="btn btn-danger" onclick="app.removeRule('ninegrid', ${index})">åˆªé™¤</button>
                        </div>
                    `;
                });

                this.rules.fixed.forEach((rule, index) => {
                    const s = this.students.find(s => s.seatNo === rule.seatNo);
                    html += `
                        <div class="rule-item">
                            <span>ğŸ”’ å›ºå®šï¼š${s?.name} â†’ ç¬¬${rule.row + 1}æ’${rule.col + 1}åˆ—</span>
                            <button class="btn btn-danger" onclick="app.removeRule('fixed', ${index})">åˆªé™¤</button>
                        </div>
                    `;
                });

                container.innerHTML = html || '<p style="color: #6c757d; font-size: 0.9em;">å°šæœªè¨­å®šè¦å‰‡</p>';
            },

            removeRule(type, index) {
                this.rules[type].splice(index, 1);
                this.renderRules();
            },

            setView(view) {
                this.config.view = view;
                document.getElementById('currentView').textContent = 
                    view === 'teacher' ? 'ç•¶å‰ï¼šæ•™å¸«è¦–è§’' : 'ç•¶å‰ï¼šå­¸ç”Ÿè¦–è§’';
                this.renderClassroom();
            },

            exportPNG() {
                const classroom = document.getElementById('classroom');
                html2canvas(classroom, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `åº§ä½è¡¨_${new Date().toLocaleDateString()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            },

            exportPDF() {
                const classroom = document.getElementById('classroom');
                html2canvas(classroom, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const imgWidth = 277;
                    const imgHeight = canvas.height * imgWidth / canvas.width;

                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    pdf.save(`åº§ä½è¡¨_${new Date().toLocaleDateString()}.pdf`);
                });
            },

            exportCSV() {
                let csv = 'æ’æ•¸,åˆ—æ•¸,åº§è™Ÿ,å§“å\n';

                for (let r = 0; r < this.config.rows; r++) {
                    for (let c = 0; c < this.config.cols; c++) {
                        const student = this.seating[r][c];
                        if (student) {
                            csv += `${r + 1},${c + 1},${student.seatNo},${student.name}\n`;
                        }
                    }
                }

                const blob = new Blob(['ï»¿' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `åº§ä½è¡¨_${new Date().toLocaleDateString()}.csv`;
                link.click();
            },

            exportJSON() {
                const data = {
                    students: this.students,
                    seating: this.seating,
                    rules: this.rules,
                    config: this.config,
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `åº§ä½è¡¨å‚™ä»½_${new Date().toLocaleDateString()}.json`;
                link.click();
            },

            saveSnapshot() {
                const name = document.getElementById('snapshotName').value || `å¿«ç…§ ${new Date().toLocaleString()}`;
                const snapshots = JSON.parse(localStorage.getItem('seatingSnapshots') || '[]');

                snapshots.push({
                    id: Date.now(),
                    name,
                    date: new Date().toISOString(),
                    data: {
                        students: this.students,
                        seating: this.seating,
                        rules: this.rules,
                        config: this.config
                    }
                });

                localStorage.setItem('seatingSnapshots', JSON.stringify(snapshots));
                document.getElementById('snapshotName').value = '';
                this.renderSnapshots();
                alert('å¿«ç…§å·²ä¿å­˜ï¼');
            },

            renderSnapshots() {
                const container = document.getElementById('snapshotsList');
                const snapshots = JSON.parse(localStorage.getItem('seatingSnapshots') || '[]');

                if (snapshots.length === 0) {
                    container.innerHTML = '<p style="color: #6c757d; font-size: 0.9em;">å°šç„¡ä¿å­˜çš„å¿«ç…§</p>';
                    return;
                }

                let html = '';
                snapshots.reverse().forEach(snapshot => {
                    html += `
                        <div class="snapshot-item">
                            <div class="snapshot-name">${snapshot.name}</div>
                            <div class="snapshot-date">${new Date(snapshot.date).toLocaleString()}</div>
                            <div class="snapshot-actions">
                                <button class="btn btn-primary" style="font-size: 0.85em;" onclick="app.loadSnapshot(${snapshot.id})">è¼‰å…¥</button>
                                <button class="btn btn-danger" style="font-size: 0.85em;" onclick="app.deleteSnapshot(${snapshot.id})">åˆªé™¤</button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            },

            loadSnapshot(id) {
                const snapshots = JSON.parse(localStorage.getItem('seatingSnapshots') || '[]');
                const snapshot = snapshots.find(s => s.id === id);

                if (snapshot) {
                    this.students = snapshot.data.students;
                    this.seating = snapshot.data.seating;
                    this.rules = snapshot.data.rules;
                    this.config = snapshot.data.config;

                    document.getElementById('rows').value = this.config.rows;
                    document.getElementById('cols').value = this.config.cols;
                    document.getElementById('emptySeats').value = this.config.emptySeats;

                    this.renderClassroom();
                    this.renderRules();
                    alert('å¿«ç…§å·²è¼‰å…¥ï¼');
                }
            },

            deleteSnapshot(id) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¿«ç…§å—ï¼Ÿ')) return;

                let snapshots = JSON.parse(localStorage.getItem('seatingSnapshots') || '[]');
                snapshots = snapshots.filter(s => s.id !== id);
                localStorage.setItem('seatingSnapshots', JSON.stringify(snapshots));
                this.renderSnapshots();
            },

            undo() {
                // Simple undo implementation
                alert('æ’¤éŠ·åŠŸèƒ½é–‹ç™¼ä¸­');
            }
        };

        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>